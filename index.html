<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-Regime Market Analysis V2.8</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/picocss/1.5.10/pico.min.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        /* V2.8 + Phase 3 å„ªåŒ–æ¨£å¼ */
        body { padding-bottom: 3rem; }
        .dashboard-container { padding: 1rem 0; }
        .market-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .summary-card { background: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: 0.5rem; padding: 1rem; text-align: center; transition: transform 0.2s; }
        .summary-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .summary-number { font-size: 1.8rem; font-weight: bold; margin: 0.5rem 0; }
        .summary-label { color: var(--muted-color); font-size: 0.9rem; }
        .dashboard-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .dashboard-table th { background: var(--secondary-background); padding: 0.8rem; text-align: left; border-bottom: 2px solid var(--border-color); cursor: pointer; position: relative; transition: background 0.2s; }
        .dashboard-table th:hover { background: var(--muted-color); }
        .dashboard-table th.sortable::after { content: ' â‡…'; color: var(--muted-color); }
        .dashboard-table th.sort-asc::after { content: ' â†‘'; color: var(--primary-color); }
        .dashboard-table th.sort-desc::after { content: ' â†“'; color: var(--primary-color); }
        .dashboard-table td { padding: 0.8rem; border-bottom: 1px solid var(--border-color); }
        .dashboard-table tbody tr:hover { background: var(--secondary-background); cursor: pointer; }
        .score-cell { font-weight: bold; text-align: center; padding: 0.4rem 0.8rem; border-radius: 0.3rem; color: white; min-width: 60px; }
        .score-strong-bullish { background-color: #16a34a; }
        .score-moderate-bullish { background-color: #22c55e; }
        .score-neutral { background-color: #6b7280; }
        .score-moderate-bearish { background-color: #f97316; }
        .score-strong-bearish { background-color: #ef4444; }
        .loading-overlay { position: relative; min-height: 200px; text-align: center; padding-top: 2rem; }
        .loading-spinner-large { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 2rem auto; }
        .filter-controls { display: flex; gap: 1rem; align-items: center; margin: 1rem 0; flex-wrap: wrap; }
        .refresh-info { display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; padding: 0.5rem; background: var(--secondary-background); border-radius: 0.3rem; font-size: 0.9rem; color: var(--muted-color); }
        .stock-detail-panel { background: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: 0.5rem; padding: 1.5rem; margin: 1rem 0; }
        .hidden { display: none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        .error-message { color: var(--pico-color-red-500); background-color: var(--pico-card-background-color); border: 1px solid var(--pico-color-red-500); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .success-message { color: var(--pico-color-green-500); background-color: #f0f9ff; border: 1px solid var(--pico-color-green-500); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        
        /* V2.8 æ–°å¢æ¨£å¼ */
        .stock-select-container { position: relative; margin-bottom: 1rem; }
        .stock-select-grid { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem; }
        .config-table-container { background: var(--card-background-color); border-radius: 0.5rem; padding: 1rem; margin: 1rem 0; }
        .config-category-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); margin: 1rem 0 0.5rem 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        .config-table { width: 100%; border-collapse: collapse; margin: 0.5rem 0 1.5rem 0; background: white; border-radius: 0.3rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .config-table th { background: var(--secondary-background); padding: 0.7rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border-color); }
        .config-table td { padding: 0.7rem; border-bottom: 1px solid #f1f5f9; }
        .config-table tbody tr:nth-child(even) { background: #f8fafc; }
        .config-table tbody tr:hover { background: #e2e8f0; }
        .config-value { font-family: 'Courier New', monospace; color: var(--primary-color); font-weight: 600; }
        .config-description { color: var(--muted-color); font-size: 0.9rem; }
        .system-info { text-align: center; padding: 1rem; background: var(--secondary-background); border-radius: 0.3rem; margin-top: 2rem; }
        
        /* Phase 2: åœ–è¡¨å®¹å™¨æ¨£å¼ */
        .chart-container { background: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: 0.5rem; padding: 1rem; margin-top: 2rem; }
        .chart-title { color: var(--primary-color); margin-bottom: 1rem; }
        
        /* Phase 3: ç­–ç•¥æƒæå„€æ¨£å¼ */
        .scanner-controls { display: flex; gap: 1rem; align-items: flex-end; margin: 1.5rem 0; padding: 1.5rem; background: var(--card-background-color); border: 1px solid var(--card-border-color); border-radius: 0.5rem; }
        .scanner-input-group { flex: 1; }
        .scanner-input-group label { display: block; margin-bottom: 0.5rem; color: var(--primary-color); }
        #scannerRuleSelect { width: 100%; padding: 0.5rem; font-size: 1rem; }
        #executeScanButton { padding: 0.75rem 2rem; font-size: 1.1rem; font-weight: bold; background: var(--primary-color); color: white; border: none; border-radius: 0.3rem; cursor: pointer; transition: all 0.2s; }
        #executeScanButton:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
        #executeScanButton:disabled { opacity: 0.6; cursor: not-allowed; }
        .scanner-summary { margin: 1rem 0; padding: 1rem; background: #f0f8ff; border-left: 4px solid var(--primary-color); border-radius: 0.3rem; }
        .summary-stats { font-size: 1.1rem; }
        .scanner-results { margin-top: 2rem; }
        .scanner-placeholder { text-align: center; padding: 3rem; color: var(--muted-color); background: var(--secondary-background); border-radius: 0.5rem; }
        .scanner-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .scanner-table th { background: var(--primary-color); color: white; padding: 0.8rem; text-align: left; position: sticky; top: 0; }
        .scanner-table td { padding: 0.8rem; border-bottom: 1px solid var(--border-color); }
        .scanner-table tbody tr:hover { background: var(--secondary-background); cursor: pointer; }
        .signal-badge { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 0.3rem; font-weight: bold; font-size: 0.9rem; }
        .signal-bullish { background: #d4f4dd; color: #16a34a; border: 1px solid #16a34a; }
        .signal-bearish { background: #fee2e2; color: #ef4444; border: 1px solid #ef4444; }
        .score-change { font-weight: bold; font-size: 1.1rem; }
        .score-up { color: #16a34a; }
        .score-down { color: #ef4444; }
        .load-more-btn { margin: 1rem auto; display: block; }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>D-Regime Market Analysis V2.8</h1>
            <p>åŸºæ–¼æ³¢å‹•ç‡ã€è¶¨å‹¢å’Œå‹•èƒ½çš„å¸‚å ´åˆ¶åº¦åˆ†æå¹³å°</p>
            <small id="apiUrl" style="color: var(--muted-color);"></small>
        </header>

        <section id="systemStatus">
            <div id="statusDisplay"></div>
        </section>

        <nav>
            <ul role="tablist">
                <li><a href="#" role="tab" class="tab-button active" data-tab="dashboard">ğŸ“Š å¸‚å ´ç¸½è¦½</a></li>
                <li><a href="#" role="tab" class="tab-button" data-tab="single">ğŸ” å–®è‚¡åˆ†æ</a></li>
                <li><a href="#" role="tab" class="tab-button" data-tab="batch">ğŸ“‹ æ‰¹é‡åˆ†æ</a></li>
                <li><a href="#" role="tab" class="tab-button" data-tab="config">âš™ï¸ ç³»çµ±é…ç½®</a></li>
                <li><a href="#" role="tab" class="tab-button" data-tab="scanner">ğŸ“ˆ ç­–ç•¥æƒæå„€</a></li>
            </ul>
        </nav>

        <main>
            <div id="dashboardPanel" class="tab-panel dashboard-container">
                <section id="marketSummary">
                    <h3>å¸‚å ´æ¦‚æ³</h3>
                    <div class="market-summary" id="summaryCards">
                        <div class="loading-overlay"><div class="loading-spinner-large"></div><p>æ­£åœ¨åŠ è¼‰å¸‚å ´æ¦‚æ³...</p></div>
                    </div>
                </section>
                <section class="filter-controls">
                    <button id="refreshDashboard" onclick="loadDashboard(false)">ğŸ”„ åˆ·æ–°æ•¸æ“š</button>
                    <button onclick="forceClearCache()">ğŸ—‘ï¸ æ¸…é™¤ç·©å­˜</button>
                    <select id="scoreFilter" onchange="applyFilterAndRender()">
                        <option value="all">æ‰€æœ‰è‚¡ç¥¨</option>
                        <option value="bullish">çœ‹æ¼²è‚¡ç¥¨ (â‰¥1åˆ†)</option>
                        <option value="bearish">çœ‹è·Œè‚¡ç¥¨ (â‰¤-1åˆ†)</option>
                        <option value="extreme">æ¥µç«¯è‚¡ç¥¨ (â‰¥3æˆ–â‰¤-3)</option>
                    </select>
                </section>
                <div id="refreshInfo" class="refresh-info hidden"></div>
                <section id="dashboardTable">
                    <h3>è‚¡ç¥¨åˆ†æç¸½è¦½</h3>
                    <div id="tableContainer">
                        <div class="loading-overlay"><div class="loading-spinner-large"></div><p>æ­£åœ¨åˆ†ææ‰€æœ‰è‚¡ç¥¨ï¼Œè«‹ç¨å€™...</p></div>
                    </div>
                </section>
                <section id="stockDetailSection" class="hidden">
                    <div id="stockDetail" class="stock-detail-panel"></div>
                </section>
            </div>

            <div id="singlePanel" class="tab-panel hidden">
                <h3>å–®è‚¡D-Regimeåˆ†æ</h3>
                <div class="stock-select-grid">
                    <div>
                        <label for="stockCodeSelect"><strong>é¸æ“‡è‚¡ç¥¨ä»£ç¢¼ï¼š</strong></label>
                        <select id="stockCodeSelect" onchange="onStockSelectChange()">
                            <option value="">è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼...</option>
                        </select>
                    </div>
                    <button id="analyzeButton" onclick="analyzeSingleStock()">ğŸ” é–‹å§‹åˆ†æ</button>
                </div>
                <div id="singleResult"></div>
                <div id="chartContainer" class="hidden chart-container">
                    <h3 class="chart-title">æ­·å²å›æ¸¬åœ–è¡¨</h3>
                    <div id="historyChart" style="width: 100%; height: 500px; border: 1px solid var(--border-color); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;">
                        <div class="loading-overlay">
                            <div class="loading-spinner-large"></div>
                            <p>æ­£åœ¨ç”Ÿæˆå®Œæ•´æ­·å²åœ–è¡¨...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="batchPanel" class="tab-panel hidden">
                <h3>æ‰¹é‡D-Regimeåˆ†æ</h3>
                <p>æ¯è¡Œè¼¸å…¥ä¸€å€‹è‚¡ç¥¨ä»£ç¢¼ï¼š</p>
                <textarea id="batchStockCodes" rows="6" placeholder="HK.00700&#10;HK.09988&#10;HK.00941"></textarea>
                <button id="batchAnalyzeButton" onclick="analyzeBatchStocks()">ğŸ“‹ æ‰¹é‡åˆ†æ</button>
                <div id="batchResult"></div>
            </div>

            <div id="configPanel" class="tab-panel hidden">
                <h3>ç³»çµ±é…ç½®åƒæ•¸</h3>
                <div id="configDisplay">
                    <div class="loading-overlay">
                        <div class="loading-spinner-large"></div>
                        <p>æ­£åœ¨åŠ è¼‰ç³»çµ±é…ç½®...</p>
                    </div>
                </div>
            </div>

            <div id="scannerPanel" class="tab-panel hidden">
                <h3>ğŸ“ˆ ç­–ç•¥æƒæå„€ - å³æ™‚ä¿¡è™Ÿåµæ¸¬</h3>
                <p>ä½¿ç”¨é å®šç¾©çš„äº¤æ˜“ä¿¡è™Ÿè¦å‰‡ï¼Œæƒæä»Šæ—¥ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ã€‚</p>
                
                <div class="scanner-controls">
                    <div class="scanner-input-group">
                        <label for="scannerRuleSelect"><strong>é¸æ“‡æƒæè¦å‰‡ï¼š</strong></label>
                        <select id="scannerRuleSelect">
                            <optgroup label="çœ‹æ¼²ä¿¡è™Ÿ">
                                <option value="åˆ¶åº¦çªç ´">ğŸš€ åˆ¶åº¦çªç ´ - é€²å…¥å¼·å‹¢å€ (ç¸½åˆ†â‰¥2)</option>
                                <option value="å‹•èƒ½é»ç«">ğŸ”¥ å‹•èƒ½é»ç« - ä¸Šå‡è¶¨å‹¢åŠ é€Ÿ</option>
                                <option value="å¹³éœå•Ÿèˆª">ğŸŒŠ å¹³éœå•Ÿèˆª - ä½æ³¢å‹•è½‰å¼·</option>
                                <option value="åº•èƒŒé›¢">ğŸ“ˆ åº•èƒŒé›¢ - ä¸‹è·Œä¸­å‹•èƒ½åè½‰</option>
                            </optgroup>
                            <optgroup label="çœ‹è·Œä¿¡è™Ÿ">
                                <option value="åˆ¶åº¦å´©å£">âš ï¸ åˆ¶åº¦å´©å£ - é€²å…¥å¼±å‹¢å€ (ç¸½åˆ†â‰¤-2)</option>
                                <option value="ææ…ŒåŠ åŠ‡">ğŸ˜± ææ…ŒåŠ åŠ‡ - é«˜æ³¢å‹•è¶¨å‹¢è½‰å¼±</option>
                                <option value="é ‚èƒŒé›¢">ğŸ“‰ é ‚èƒŒé›¢ - ä¸Šæ¼²ä¸­å‹•èƒ½è¡°é€€</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="executeScanButton" onclick="executeScan()">
                        ğŸ” é–‹å§‹æƒæ
                    </button>
                </div>
                
                <div id="scannerSummary" class="scanner-summary hidden">
                    <div class="summary-stats">
                        <span id="scannerStats"></span>
                    </div>
                </div>
                
                <div id="scannerResults" class="scanner-results">
                    <div class="scanner-placeholder">
                        <p>ğŸ‘† è«‹é¸æ“‡æƒæè¦å‰‡ä¸¦é»æ“Šã€Œé–‹å§‹æƒæã€ä»¥æŸ¥çœ‹ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</p>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>D-Regime Analysis Platform V2.8 | æ•¸æ“šæ›´æ–°æ™‚é–“: <span id="lastUpdate">--</span></p>
        </footer>
    </div>

    <script>
    // ==============================================================================
    // D-REGIME V2.8 GitHub Pages ç‰ˆæœ¬ - å®Œæ•´å‰ç«¯ä»£ç¢¼
    // ==============================================================================
    
    // API é…ç½® - è«‹æ›¿æ›ç‚ºä½ çš„ Google Apps Script URL
    const API_CONFIG = {
        baseUrl: 'https://script.google.com/macros/s/AKfycbx2qTIeeR3LHVRUoENrXVT5nfbpxLSMNIR9lzB9Ek8gDRLWE_wvB3zbdVH81YOpthnh/exec', // 
        timeout: 30000,
        retryAttempts: 3,
        retryDelay: 1000
    };

    // é¡¯ç¤º API URLï¼ˆåƒ…ä¾›èª¿è©¦ï¼‰
    document.getElementById('apiUrl').textContent = `API: ${API_CONFIG.baseUrl.substring(0, 50)}...`;

    // ==============================================================================
    // API æœå‹™å±¤
    // ==============================================================================
    class ApiService {
        static async call(action, params = {}) {
            const url = new URL(API_CONFIG.baseUrl);
            url.searchParams.append('mode', 'api');
            url.searchParams.append('action', action);
            
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== null) {
                    url.searchParams.append(key, params[key]);
                }
            });

            for (let attempt = 1; attempt <= API_CONFIG.retryAttempts; attempt++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
                    
                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        signal: controller.signal,
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data;
                    
                } catch (error) {
                    console.error(`API call attempt ${attempt} failed:`, error);
                    
                    if (attempt === API_CONFIG.retryAttempts) {
                        throw error;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, API_CONFIG.retryDelay * attempt));
                }
            }
        }

        static async post(action, data = {}) {
            const url = new URL(API_CONFIG.baseUrl);
            
            for (let attempt = 1; attempt <= API_CONFIG.retryAttempts; attempt++) {
                try {
                    const response = await fetch(url.toString(), {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action, ...data })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                    
                } catch (error) {
                    if (attempt === API_CONFIG.retryAttempts) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, API_CONFIG.retryDelay * attempt));
                }
            }
        }
    }

    // ==============================================================================
    // æœ¬åœ°ç·©å­˜å±¤
    // ==============================================================================
    class LocalCache {
        static set(key, value, ttl = 3600000) {
            try {
                const item = {
                    value: value,
                    expiry: new Date().getTime() + ttl
                };
                localStorage.setItem(key, JSON.stringify(item));
            } catch (e) {
                console.warn('LocalStorage error:', e);
            }
        }
        
        static get(key) {
            try {
                const itemStr = localStorage.getItem(key);
                if (!itemStr) return null;
                
                const item = JSON.parse(itemStr);
                if (new Date().getTime() > item.expiry) {
                    localStorage.removeItem(key);
                    return null;
                }
                return item.value;
            } catch (e) {
                console.warn('LocalStorage error:', e);
                return null;
            }
        }
        
        static clear() {
            try {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('d_regime_')) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {
                console.warn('LocalStorage clear error:', e);
            }
        }
    }

    // ==============================================================================
    // å…¨å±€è®Šé‡
    // ==============================================================================
    let dashboardData = [], filteredData = [], currentSortColumn = 'totalScore', currentSortDirection = 'desc';
    let availableStocks = [];

    // ==============================================================================
    // åˆå§‹åŒ–
    // ==============================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('ğŸš€ D-Regime V2.8 GitHub Pages ç‰ˆæœ¬åˆå§‹åŒ–');
        setupTabs();
        await testConnection();
        await loadAvailableStocks();
        await loadSystemConfig();
        setTimeout(() => loadDashboard(true), 500);
    });

    // ==============================================================================
    // é€£æ¥æ¸¬è©¦
    // ==============================================================================
    async function testConnection() {
        try {
            const response = await ApiService.call('getHello');
            if (response.success || response.message) {
                document.getElementById('statusDisplay').innerHTML = `
                    <div class="success-message">
                        <strong>ğŸŸ¢ ç³»çµ±ç‹€æ…‹ï¼š</strong>å¾Œç«¯é€£æ¥æˆåŠŸ
                    </div>
                `;
                console.log('âœ… å¾Œç«¯é€£æ¥æˆåŠŸ');
            }
        } catch (error) {
            document.getElementById('statusDisplay').innerHTML = `
                <div class="error-message">
                    <strong>ğŸ”´ ç³»çµ±ç‹€æ…‹ï¼š</strong>ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯æœå‹™ - ${error.message}
                </div>
            `;
            console.error('âŒ å¾Œç«¯é€£æ¥å¤±æ•—:', error);
        }
    }

    // ==============================================================================
    // å„€è¡¨æ¿åŠŸèƒ½
    // ==============================================================================
    async function loadDashboard(useCache = true) {
        setDashboardLoading(true);
        console.log(`ğŸ“Š åŠ è¼‰å„€è¡¨æ¿æ•¸æ“š (ç·©å­˜: ${useCache})`);
        
        // æª¢æŸ¥æœ¬åœ°ç·©å­˜
        if (useCache) {
            const cached = LocalCache.get('d_regime_dashboard');
            if (cached) {
                console.log('âœ… ä½¿ç”¨æœ¬åœ°ç·©å­˜æ•¸æ“š');
                handleDashboardData(cached);
                setDashboardLoading(false);
                return;
            }
        }
        
        try {
            const response = await ApiService.call('getDashboardData', { useCache: useCache.toString() });
            setDashboardLoading(false);
            
            // ä¿å­˜åˆ°æœ¬åœ°ç·©å­˜
            if (response.success) {
                LocalCache.set('d_regime_dashboard', response, 600000); // 10åˆ†é˜
            }
            
            handleDashboardData(response);
        } catch (error) {
            setDashboardLoading(false);
            showError('tableContainer', `å„€è¡¨æ¿åŠ è¼‰å¤±æ•—: ${error.message}`);
            console.error('Dashboard loading error:', error);
        }
    }

    function handleDashboardData(response) {
        if (!response.success) {
            showError('tableContainer', `ç²å–æ•¸æ“šå¤±æ•—: ${response.error}`);
            return;
        }
        
        console.log(`âœ… æˆåŠŸåŠ è¼‰ ${response.data.length} æ”¯è‚¡ç¥¨æ•¸æ“š`);
        dashboardData = response.data;
        updateRefreshInfo(response);
        applyFilterAndRender();
        loadMarketSummary();
    }

    async function loadMarketSummary() {
        try {
            const response = await ApiService.call('getEnhancedMarketSummary');
            if (response.success) {
                renderMarketSummary(response.data);
            }
        } catch (error) {
            console.error('Market summary loading error:', error);
        }
    }

    function renderMarketSummary(summary) {
        const avgScore = parseFloat(summary.averageScore);
        const marketCondition = summary.marketCondition;
        const dist = summary.distribution;
        
        document.getElementById('summaryCards').innerHTML = `
            <div class="summary-card">
                <div class="summary-number">${summary.totalStocks}</div>
                <div class="summary-label">ç¸½è‚¡ç¥¨æ•¸</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: ${getScoreColor(avgScore)}">${summary.averageScore}</div>
                <div class="summary-label">å¹³å‡åˆ†æ•¸ (${marketCondition})</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: #16a34a">${dist.strongBullish}</div>
                <div class="summary-label">å¼·çœ‹æ¼² (â‰¥3åˆ†)</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: #22c55e">${dist.bullish}</div>
                <div class="summary-label">çœ‹æ¼² (2åˆ†)</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: #6b7280">${dist.neutral}</div>
                <div class="summary-label">ä¸­æ€§ (-1~1åˆ†)</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: #f97316">${dist.bearish}</div>
                <div class="summary-label">çœ‹è·Œ (-2åˆ†)</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" style="color: #ef4444">${dist.strongBearish}</div>
                <div class="summary-label">å¼·çœ‹è·Œ (â‰¤-3åˆ†)</div>
            </div>`;
    }

    function renderDashboardTable() {
        const container = document.getElementById('tableContainer');
        if (!filteredData || filteredData.length === 0) {
            container.innerHTML = '<div class="error-message">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è‚¡ç¥¨æ•¸æ“šã€‚</div>';
            return;
        }
        
        sortData();
        let tableHtml = `
            <table class="dashboard-table">
                <thead>
                    <tr>
                        <th class="sortable" data-column="stockCode">è‚¡ç¥¨ä»£ç¢¼</th>
                        <th class="sortable" data-column="totalScore">D-Regimeåˆ†æ•¸</th>
                        <th class="sortable" data-column="breakdown.volatility">æ³¢å‹•ç‡</th>
                        <th class="sortable" data-column="breakdown.trend">è¶¨å‹¢</th>
                        <th class="sortable" data-column="breakdown.momentum">å‹•èƒ½</th>
                        <th>è§£é‡‹</th>
                        <th class="sortable" data-column="timestamp">åˆ†ææ™‚é–“</th>
                    </tr>
                </thead>
                <tbody>`;
        
        filteredData.forEach(stock => {
            const analysisTime = new Date(stock.timestamp).toLocaleString('zh-CN', {
                month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit'
            });
            
            tableHtml += `
                <tr onclick="showStockDetail('${stock.stockCode}')" title="é»æ“ŠæŸ¥çœ‹è©³ç´°åˆ†æ">
                    <td><strong>${stock.stockCode}</strong></td>
                    <td><div class="score-cell ${getScoreClass(stock.totalScore)}">${stock.totalScore}</div></td>
                    <td style="text-align: center; color: ${getScoreColor(stock.breakdown.volatility)}">${stock.breakdown.volatility}</td>
                    <td style="text-align: center; color: ${getScoreColor(stock.breakdown.trend)}">${stock.breakdown.trend}</td>
                    <td style="text-align: center; color: ${getScoreColor(stock.breakdown.momentum)}">${stock.breakdown.momentum}</td>
                    <td><small>${stock.interpretation}</small></td> 
                    <td><small>${analysisTime}</small></td>
                </tr>`;
        });
        
        container.innerHTML = tableHtml + '</tbody></table>';
        updateSortIndicators();
        setupTableSorting();
        
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
    }

    // ==============================================================================
    // å–®è‚¡åˆ†æåŠŸèƒ½
    // ==============================================================================
    async function loadAvailableStocks() {
        console.log('ğŸ“ åŠ è¼‰å¯ç”¨è‚¡ç¥¨åˆ—è¡¨...');
        
        // æª¢æŸ¥ç·©å­˜
        const cached = LocalCache.get('d_regime_stocks');
        if (cached) {
            console.log('âœ… ä½¿ç”¨ç·©å­˜çš„è‚¡ç¥¨åˆ—è¡¨');
            availableStocks = cached;
            populateStockSelect(cached);
            return;
        }
        
        try {
            const response = await ApiService.call('getAvailableStocks');
            if (response.success) {
                availableStocks = response.data;
                populateStockSelect(response.data);
                LocalCache.set('d_regime_stocks', response.data, 3600000); // 1å°æ™‚ç·©å­˜
                console.log(`âœ… æˆåŠŸåŠ è¼‰ ${response.count} æ”¯è‚¡ç¥¨`);
            } else {
                showError('singleResult', `åŠ è¼‰è‚¡ç¥¨åˆ—è¡¨å¤±æ•—: ${response.error}`);
            }
        } catch (error) {
            showError('singleResult', `é€£æ¥å¾Œç«¯å¤±æ•—: ${error.message}`);
        }
    }

    function populateStockSelect(stocks) {
        const select = document.getElementById('stockCodeSelect');
        select.innerHTML = '<option value="">è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼...</option>';
        
        stocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.code || stock;
            const displayText = stock.dataRows ? 
                `${stock.code} (${stock.dataRows}è¡Œæ•¸æ“š)` : 
                (stock.code || stock);
            option.textContent = displayText;
            select.appendChild(option);
        });
    }

    function onStockSelectChange() {
        const select = document.getElementById('stockCodeSelect');
        if (select.value) {
            analyzeSingleStock();
        }
    }

    async function analyzeSingleStock() {
        const stockCode = document.getElementById('stockCodeSelect').value;
        if (!stockCode) {
            alert('è«‹é¸æ“‡è‚¡ç¥¨ä»£ç¢¼');
            return;
        }
        
        console.log(`ğŸ” åˆ†æå–®è‚¡: ${stockCode}`);
        
        const button = document.getElementById('analyzeButton');
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> åˆ†æä¸­...';
        
        document.getElementById('singleResult').innerHTML = `<div class="loading-overlay"><p>æ­£åœ¨åˆ†æ ${stockCode}...</p></div>`;
        document.getElementById('chartContainer').classList.add('hidden');

        try {
            const response = await ApiService.call('getSingleRegimeScore', { stockCode });
            button.disabled = false;
            button.innerHTML = 'ğŸ” é–‹å§‹åˆ†æ';
            displaySingleResult(response);

            if (response.success) {
                await loadAndRenderHistoryChartWithSignals(response.stockCode);
            }
        } catch (error) {
            button.disabled = false;
            button.innerHTML = 'ğŸ” é–‹å§‹åˆ†æ';
            showError('singleResult', `åˆ†æå¤±æ•—: ${error.message}`);
        }
    }

    function displaySingleResult(result) {
        const container = document.getElementById('singleResult');
        
        if (!result.success) {
            showError('singleResult', `åˆ†æ ${result.stockCode} å¤±æ•—: ${result.error}`);
            return;
        }
        
        const data = result.data;
        const scoreClass = getScoreClass(data.totalScore);
        const scoreColor = getScoreColor(data.totalScore);

        container.innerHTML = `
            <article style="border: 2px solid ${scoreColor}; border-radius: 0.5rem; padding: 2rem; margin-top: 1rem;">
                <header style="text-align: center; margin-bottom: 2rem;">
                    <h2>${result.stockCode} åˆ†æçµæœ</h2>
                    <div class="score-cell ${scoreClass}" style="font-size: 3rem; padding: 1rem; margin: 1rem auto; display: inline-block;">
                        ${data.totalScore}
                    </div>
                    <h3 style="color: ${scoreColor}; margin: 0.5rem 0;">
                        ${data.interpretation} 
                    </h3>
                </header>
                
                <section>
                    <h4>ğŸ“Š åˆ†æ•¸çµ„æˆï¼š</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div style="text-align: center; padding: 1rem; background: var(--secondary-background); border-radius: 0.3rem;">
                            <div style="font-size: 1.5rem; color: ${getScoreColor(data.breakdown.volatility)}; font-weight: bold;">
                                ${data.breakdown.volatility}
                            </div>
                            <div>æ³¢å‹•ç‡åˆ¶åº¦</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--secondary-background); border-radius: 0.3rem;">
                            <div style="font-size: 1.5rem; color: ${getScoreColor(data.breakdown.trend)}; font-weight: bold;">
                                ${data.breakdown.trend}
                            </div>
                            <div>è¶¨å‹¢åˆ¶åº¦</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--secondary-background); border-radius: 0.3rem;">
                            <div style="font-size: 1.5rem; color: ${getScoreColor(data.breakdown.momentum)}; font-weight: bold;">
                                ${data.breakdown.momentum}
                            </div>
                            <div>å‹•èƒ½åˆ¶åº¦</div>
                        </div>
                    </div>
                </section>
                
                <section style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                    <h4>ğŸ’¡ æŠ•è³‡å»ºè­°ï¼š</h4>
                    <p style="font-size: 1.1rem; line-height: 1.6;">æ ¹æ“š D-Regime åˆ†æ•¸ ${data.totalScore}ï¼Œç›®å‰çš„å¸‚å ´åˆ¶åº¦ç‚ºã€Œ${data.interpretation}ã€ã€‚</p>
                    <p style="margin-top: 1rem;"><small>åˆ†ææ™‚é–“ï¼š${new Date(result.timestamp).toLocaleString()}</small></p>
                </section>
            </article>
        `;
    }

    // ==============================================================================
    // æ­·å²åœ–è¡¨åŠŸèƒ½
    // ==============================================================================
    async function loadAndRenderHistoryChartWithSignals(stockCode) {
        console.log(`ğŸ“ˆ é–‹å§‹è¼‰å…¥ ${stockCode} çš„æ­·å²åœ–è¡¨ï¼ˆå«ä¿¡è™Ÿï¼‰`);
        
        const chartContainer = document.getElementById('chartContainer');
        const chartDiv = document.getElementById('historyChart');
        
        chartContainer.classList.remove('hidden');
        chartDiv.innerHTML = `
            <div class="loading-overlay">
                <div class="loading-spinner-large"></div>
                <p>æ­£åœ¨ç”Ÿæˆå®Œæ•´æ­·å²åœ–è¡¨åŠä¿¡è™Ÿæ¨™è¨»...</p>
            </div>`;

        try {
            const response = await ApiService.call('getHistoricalRegimeScoresWithSignals', { stockCode });
            console.log("æ­·å²æ•¸æ“šéŸ¿æ‡‰:", response);
            
            if (response.success) {
                console.log(`âœ… æˆåŠŸç²å– ${response.data.length} ç­†æ­·å²æ•¸æ“š`);
                drawChartWithSignals(response.data, stockCode);
            } else {
                showError('historyChart', 'ç„¡æ³•åŠ è¼‰æ­·å²åœ–è¡¨æ•¸æ“š: ' + response.error);
            }
        } catch (error) {
            console.error("API èª¿ç”¨å¤±æ•—:", error);
            showError('historyChart', 'è«‹æ±‚æ­·å²æ•¸æ“šå¤±æ•—: ' + error.message);
        }
    }

    function drawChartWithSignals(data, stockCode) {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => {
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('date', 'æ—¥æœŸ');
            dataTable.addColumn('number', 'æ”¶ç›¤åƒ¹');
            dataTable.addColumn('number', 'D-Regime æ­£åˆ†');
            dataTable.addColumn('number', 'D-Regime è² åˆ†');
            dataTable.addColumn({type: 'string', role: 'annotation'});
            dataTable.addColumn({type: 'string', role: 'annotationText'});
            
            const rows = data.map((item, index) => {
                const score = item.score;
                let annotation = null;
                let annotationText = null;
                
                if (index > 0 && item.signals && item.signals.length > 0) {
                    const signalMarks = {
                        'åˆ¶åº¦çªç ´': 'çª',
                        'å‹•èƒ½é»ç«': 'ç«',
                        'å¹³éœå•Ÿèˆª': 'èˆª',
                        'åº•èƒŒé›¢': 'åº•',
                        'åˆ¶åº¦å´©å£': 'å´©',
                        'ææ…ŒåŠ åŠ‡': 'æ',
                        'é ‚èƒŒé›¢': 'é ‚'
                    };
                    
                    const firstSignal = item.signals[0];
                    annotation = signalMarks[firstSignal.name] || '';
                    annotationText = firstSignal.name;
                }
                
                return [
                    new Date(item.date),
                    item.price,
                    score >= 0 ? score : null,
                    score < 0 ? score : null,
                    annotation,
                    annotationText
                ];
            });
            
            dataTable.addRows(rows);
            
            const options = {
                title: `${stockCode} è‚¡åƒ¹ vs D-Regime åˆ†æ•¸`,
                seriesType: 'line',
                series: {
                    0: { targetAxisIndex: 0, color: '#3498db', lineWidth: 2 },
                    1: { targetAxisIndex: 1, type: 'bars', color: '#16a34a' },
                    2: { targetAxisIndex: 1, type: 'bars', color: '#ef4444' }
                },
                vAxes: {
                    0: { title: 'è‚¡åƒ¹ (HKD)', viewWindow: { min: 0 } },
                    1: { title: 'D-Regime åˆ†æ•¸', viewWindow: { min: -5, max: 5 } }
                },
                hAxis: { title: 'æ—¥æœŸ', format: 'MM/dd' },
                legend: { position: 'top' },
                chartArea: { width: '85%', height: '70%' },
                backgroundColor: { fill: '#f8f9fa' }
            };
            
            const chart = new google.visualization.ComboChart(document.getElementById('historyChart'));
            chart.draw(dataTable, options);
        });
    }

    // ==============================================================================
    // æ‰¹é‡åˆ†æåŠŸèƒ½
    // ==============================================================================
    async function analyzeBatchStocks() {
        const input = document.getElementById('batchStockCodes').value.trim();
        if (!input) {
            alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
            return;
        }
        
        const stockCodes = input.split('\n').map(code => code.trim()).filter(code => code);
        if (stockCodes.length === 0) {
            alert('æ²’æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼');
            return;
        }
        
        console.log(`ğŸ“‹ æ‰¹é‡åˆ†æ ${stockCodes.length} æ”¯è‚¡ç¥¨`);
        
        const button = document.getElementById('batchAnalyzeButton');
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> åˆ†æä¸­...';
        
        document.getElementById('batchResult').innerHTML = `
            <div class="loading-overlay">
                <div class="loading-spinner-large"></div>
                <p>æ­£åœ¨æ‰¹é‡åˆ†æ ${stockCodes.length} æ”¯è‚¡ç¥¨...</p>
            </div>
        `;
        
        try {
            const results = await Promise.allSettled(
                stockCodes.map(code => ApiService.call('getSingleRegimeScore', { stockCode: code }))
            );
            
            button.disabled = false;
            button.innerHTML = 'ğŸ“‹ æ‰¹é‡åˆ†æ';
            displayBatchResults(results, stockCodes);
        } catch (error) {
            button.disabled = false;
            button.innerHTML = 'ğŸ“‹ æ‰¹é‡åˆ†æ';
            showError('batchResult', `æ‰¹é‡åˆ†æå¤±æ•—: ${error.message}`);
        }
    }

    function displayBatchResults(results, stockCodes) {
        let html = '<h4>æ‰¹é‡åˆ†æçµæœ</h4>';
        let successCount = 0;
        
        html += '<table class="dashboard-table"><thead><tr><th>è‚¡ç¥¨ä»£ç¢¼</th><th>åˆ†æ•¸</th><th>ç‹€æ…‹</th></tr></thead><tbody>';
        
        results.forEach((result, index) => {
            const stockCode = stockCodes[index];
            if (result.status === 'fulfilled' && result.value.success) {
                const data = result.value.data;
                html += `
                    <tr>
                        <td><strong>${stockCode}</strong></td>
                        <td><div class="score-cell ${getScoreClass(data.totalScore)}">${data.totalScore}</div></td>
                        <td style="color: #16a34a;">âœ… æˆåŠŸ</td>
                    </tr>
                `;
                successCount++;
            } else {
                html += `
                    <tr>
                        <td><strong>${stockCode}</strong></td>
                        <td>--</td>
                        <td style="color: #ef4444;">âŒ å¤±æ•—</td>
                    </tr>
                `;
            }
        });
        
        html += '</tbody></table>';
        html += `<p><strong>ç¸½çµï¼š</strong>æˆåŠŸåˆ†æ ${successCount}/${stockCodes.length} æ”¯è‚¡ç¥¨</p>`;
        
        document.getElementById('batchResult').innerHTML = html;
    }

    // ==============================================================================
    // ç³»çµ±é…ç½®åŠŸèƒ½
    // ==============================================================================
    async function loadSystemConfig() {
        console.log('âš™ï¸ åŠ è¼‰ç³»çµ±é…ç½®...');
        
        const container = document.getElementById('configDisplay');
        container.innerHTML = `
            <div class="loading-overlay">
                <div class="loading-spinner-large"></div>
                <p>æ­£åœ¨åŠ è¼‰ç³»çµ±é…ç½®...</p>
            </div>
        `;
        
        try {
            const response = await ApiService.call('getSystemConfigWithDescriptions');
            if (response.success) {
                displaySystemConfig(response.data);
            } else {
                showError('configDisplay', `åŠ è¼‰é…ç½®å¤±æ•—: ${response.error}`);
            }
        } catch (error) {
            showError('configDisplay', `ç„¡æ³•é€£æ¥å¾Œç«¯: ${error.message}`);
        }
    }

    function displaySystemConfig(configData) {
        let html = '<div class="config-table-container">';
        
        configData.configItems.forEach(category => {
            html += `
                <h3 class="config-category-title">${category.category}</h3>
                <table class="config-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">åƒæ•¸åç¨±</th>
                            <th style="width: 15%;">ç•¶å‰æ•¸å€¼</th>
                            <th style="width: 60%;">èªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            category.items.forEach(item => {
                html += `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td><span class="config-value">${item.value}</span></td>
                        <td><span class="config-description">${item.description}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
        });
        
        html += `
            <div class="system-info">
                <p><strong>ç³»çµ±ç‰ˆæœ¬ï¼š</strong>${configData.systemVersion}</p>
                <p><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>${new Date(configData.lastUpdated).toLocaleString()}</p>
            </div>
        </div>`;
        
        document.getElementById('configDisplay').innerHTML = html;
    }

    // ==============================================================================
    // ç­–ç•¥æƒæå„€åŠŸèƒ½
    // ==============================================================================
    async function executeScan() {
        const ruleName = document.getElementById('scannerRuleSelect').value;
        if (!ruleName) {
            alert('è«‹é¸æ“‡æƒæè¦å‰‡');
            return;
        }
        
        console.log(`ğŸ“ˆ é–‹å§‹æƒæ: ${ruleName}`);
        
        const button = document.getElementById('executeScanButton');
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> æƒæä¸­...';
        
        document.getElementById('scannerResults').innerHTML = `
            <div class="loading-overlay">
                <div class="loading-spinner-large"></div>
                <p>æ­£åœ¨æƒææ‰€æœ‰è‚¡ç¥¨ï¼Œå°‹æ‰¾ã€Œ${ruleName}ã€ä¿¡è™Ÿ...</p>
            </div>
        `;
        
        document.getElementById('scannerSummary').classList.add('hidden');
        
        try {
            const response = await ApiService.call('runScanner', { ruleName });
            button.disabled = false;
            button.innerHTML = 'ğŸ” é–‹å§‹æƒæ';
            displayScannerResults(response);
        } catch (error) {
            button.disabled = false;
            button.innerHTML = 'ğŸ” é–‹å§‹æƒæ';
            showError('scannerResults', `æƒæå¤±æ•—: ${error.message}`);
        }
    }

    const SCANNER_PAGE_SIZE = 50;
    let scannerData = [];
    let scannerRendered = 0;
    let scannerRuleName = '';

    function displayScannerResults(response) {
        if (!response.success) {
            showError('scannerResults', `æƒæå¤±æ•—: ${response.error}`);
            return;
        }

        const { ruleName, resultsCount, totalScanned, executionTime, data } = response;

        const summaryDiv = document.getElementById('scannerSummary');
        const statsSpan = document.getElementById('scannerStats');

        if (resultsCount > 0) {
            statsSpan.innerHTML = `
                <strong>âœ… æƒæå®Œæˆï¼</strong>
                åœ¨ ${totalScanned} æ”¯è‚¡ç¥¨ä¸­æ‰¾åˆ° <strong style="color: var(--primary-color); font-size: 1.3rem;">${resultsCount}</strong> å€‹ã€Œ${ruleName}ã€ä¿¡è™Ÿ
                (è€—æ™‚: ${executionTime})
            `;
            summaryDiv.classList.remove('hidden');
        } else {
            statsSpan.innerHTML = `
                <strong>â„¹ï¸ æƒæå®Œæˆ</strong>
                åœ¨ ${totalScanned} æ”¯è‚¡ç¥¨ä¸­æ²’æœ‰æ‰¾åˆ°ç¬¦åˆã€Œ${ruleName}ã€çš„ä¿¡è™Ÿ
                (è€—æ™‚: ${executionTime})
            `;
            summaryDiv.classList.remove('hidden');
        }

        const resultsDiv = document.getElementById('scannerResults');

        if (data.length === 0) {
            resultsDiv.innerHTML = `
                <div class="scanner-placeholder">
                    <h4>ğŸ“­ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</h4>
                    <p>ä»Šæ—¥å¸‚å ´ä¸­æ²’æœ‰è‚¡ç¥¨è§¸ç™¼ã€Œ${ruleName}ã€ä¿¡è™Ÿã€‚</p>
                </div>
            `;
            return;
        }

        scannerData = data;
        scannerRendered = 0;
        scannerRuleName = ruleName;

        resultsDiv.innerHTML = `
            <table class="scanner-table">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç¢¼</th>
                        <th>ä»Šæ—¥åˆ†æ•¸</th>
                        <th>æ˜¨æ—¥åˆ†æ•¸</th>
                        <th>è®ŠåŒ–</th>
                        <th>ä¿¡è™Ÿé¡å‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="scannerResultsBody"></tbody>
            </table>
            ${data.length > SCANNER_PAGE_SIZE ? '<button id="loadMoreScanner" class="load-more-btn">è¼‰å…¥æ›´å¤š</button>' : ''}
        `;

        renderNextScannerResults();

        const loadMoreBtn = document.getElementById('loadMoreScanner');
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', renderNextScannerResults);
        }
    }

    function renderNextScannerResults() {
        const tbody = document.getElementById('scannerResultsBody');
        const slice = scannerData.slice(scannerRendered, scannerRendered + SCANNER_PAGE_SIZE);

        slice.forEach(stock => {
            const scoreChange = stock.todayScore - stock.yesterdayScore;
            const changeClass = scoreChange > 0 ? 'score-up' : 'score-down';
            const changeSymbol = scoreChange > 0 ? 'â†‘' : 'â†“';
            const signalClass = ['åˆ¶åº¦çªç ´', 'å‹•èƒ½é»ç«', 'å¹³éœå•Ÿèˆª', 'åº•èƒŒé›¢'].includes(scannerRuleName) ?
                               'signal-bullish' : 'signal-bearish';

            const rowHtml = `
                <tr onclick="viewStockFromScanner('${stock.stockCode}')" title="é»æ“ŠæŸ¥çœ‹è©³ç´°åˆ†æ">
                    <td><strong>${stock.stockCode}</strong></td>
                    <td>
                        <div class="score-cell ${getScoreClass(stock.todayScore)}">
                            ${stock.todayScore}
                        </div>
                    </td>
                    <td>
                        <div class="score-cell ${getScoreClass(stock.yesterdayScore)}">
                            ${stock.yesterdayScore}
                        </div>
                    </td>
                    <td>
                        <span class="score-change ${changeClass}">
                            ${changeSymbol} ${Math.abs(scoreChange)}
                        </span>
                    </td>
                    <td>
                        <span class="signal-badge ${signalClass}">
                            ${scannerRuleName}
                        </span>
                    </td>
                    <td>
                        <button onclick="event.stopPropagation(); analyzeScannerStock('${stock.stockCode}')"
                                style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">
                            ğŸ“Š åˆ†æ
                        </button>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', rowHtml);
        });

        scannerRendered += slice.length;
        if (scannerRendered >= scannerData.length) {
            const loadMoreBtn = document.getElementById('loadMoreScanner');
            if (loadMoreBtn) loadMoreBtn.classList.add('hidden');
        }
    }

    function viewStockFromScanner(stockCode) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
        
        const singleTab = document.querySelector('[data-tab="single"]');
        singleTab.classList.add('active');
        document.getElementById('singlePanel').classList.remove('hidden');
        
        document.getElementById('stockCodeSelect').value = stockCode;
        analyzeSingleStock();
    }

    function analyzeScannerStock(stockCode) {
        viewStockFromScanner(stockCode);
    }

    // ==============================================================================
    // è¡¨æ ¼æ’åºå’Œç¯©é¸
    // ==============================================================================
    function setupTableSorting() {
        document.querySelectorAll('.dashboard-table th.sortable').forEach(header => {
            header.addEventListener('click', () => sortTableByColumn(header.dataset.column));
        });
    }

    function sortTableByColumn(column) {
        currentSortDirection = (currentSortColumn === column && currentSortDirection === 'desc') ? 'asc' : 'desc';
        currentSortColumn = column;
        renderDashboardTable();
    }

    function sortData() {
        filteredData.sort((a, b) => {
            let aVal = getNestedValue(a, currentSortColumn);
            let bVal = getNestedValue(b, currentSortColumn);
            
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            }
            
            const aStr = String(aVal).toLowerCase();
            const bStr = String(bVal).toLowerCase();
            return currentSortDirection === 'asc' ? aStr.localeCompare(bStr) : bStr.localeCompare(aStr);
        });
    }
    
    function applyFilterAndRender() {
        const filter = document.getElementById('scoreFilter').value;
        
        switch(filter) {
            case 'bullish':
                filteredData = dashboardData.filter(s => s.totalScore >= 1);
                break;
            case 'bearish':
                filteredData = dashboardData.filter(s => s.totalScore <= -1);
                break;
            case 'extreme':
                filteredData = dashboardData.filter(s => s.totalScore >= 3 || s.totalScore <= -3);
                break;
            default:
                filteredData = [...dashboardData];
        }
        
        renderDashboardTable();
    }

    function showStockDetail(stockCode) {
        const stock = dashboardData.find(s => s.stockCode === stockCode);
        if (!stock) return;
        
        const detailHtml = `
            <h4>ğŸ“ˆ ${stockCode} - è©³ç´°åˆ†æå ±å‘Š</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                <div style="text-align: center;">
                    <div class="score-cell ${getScoreClass(stock.totalScore)}" style="display: inline-block; font-size: 1.5rem; padding: 1rem;">
                        ${stock.totalScore}
                    </div>
                    <div style="margin-top: 0.5rem; font-weight: bold;">${stock.interpretation}</div>
                </div>
                <div>
                    <h5>çµ„æˆåˆ†æ•¸ï¼š</h5>
                    <ul>
                        <li><strong>æ³¢å‹•ç‡ï¼š</strong> <span style="color: ${getScoreColor(stock.breakdown.volatility)}">${stock.breakdown.volatility}</span></li>
                        <li><strong>è¶¨å‹¢ï¼š</strong> <span style="color: ${getScoreColor(stock.breakdown.trend)}">${stock.breakdown.trend}</span></li>
                        <li><strong>å‹•èƒ½ï¼š</strong> <span style="color: ${getScoreColor(stock.breakdown.momentum)}">${stock.breakdown.momentum}</span></li>
                    </ul>
                </div>
            </div>
            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                <h5>ğŸ“‹ æŠ•è³‡å»ºè­°ï¼š</h5>
                <p>æ ¹æ“š D-Regime åˆ†æ•¸ ${stock.totalScore}ï¼Œç›®å‰çš„å¸‚å ´åˆ¶åº¦ç‚ºã€Œ${stock.interpretation}ã€ã€‚</p>
                <p><small>åˆ†ææ™‚é–“ï¼š${new Date(stock.timestamp).toLocaleString()}</small></p>
            </div>
            <button onclick="document.getElementById('stockDetailSection').classList.add('hidden')" style="margin-top: 1rem;">é—œé–‰è©³ç´°åˆ†æ</button>
        `;
        
        document.getElementById('stockDetail').innerHTML = detailHtml;
        const section = document.getElementById('stockDetailSection');
        section.classList.remove('hidden');
        section.scrollIntoView({ behavior: 'smooth' });
    }

    function updateSortIndicators() {
        document.querySelectorAll('.dashboard-table th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        
        const currentHeader = document.querySelector(`[data-column="${currentSortColumn}"]`);
        if (currentHeader) {
            currentHeader.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    }

    // ==============================================================================
    // ç·©å­˜ç®¡ç†
    // ==============================================================================
    function setDashboardLoading(isLoading) {
        const button = document.getElementById('refreshDashboard');
        button.disabled = isLoading;
        button.innerHTML = isLoading ? '<span class="loading-spinner"></span> åˆ†æä¸­...' : 'ğŸ”„ åˆ·æ–°æ•¸æ“š';
    }

    function updateRefreshInfo(response) {
        const info = document.getElementById('refreshInfo');
        if (response.timestamp) {
            const refreshTime = new Date(response.timestamp).toLocaleString();
            const summary = response.summary;
            const cacheStatus = response.fromCache ? 'ï¼ˆç·©å­˜ï¼‰' : 'ï¼ˆå¯¦æ™‚ï¼‰';
            info.innerHTML = `
                <span>æœ€å¾Œåˆ·æ–°: ${refreshTime} ${cacheStatus}</span>
                <span>æˆåŠŸ: ${summary.successful}/${summary.totalStocks} | è€—æ™‚: ${summary.executionTime}</span>
            `;
            info.classList.remove('hidden');
        }
    }

    async function forceClearCache() {
        if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤ç·©å­˜å—ï¼Ÿé€™å°‡å¼·åˆ¶é‡æ–°åˆ†ææ‰€æœ‰è‚¡ç¥¨ï¼Œå¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ã€‚')) return;
        
        // æ¸…é™¤æœ¬åœ°ç·©å­˜
        LocalCache.clear();
        
        setDashboardLoading(true);
        try {
            const response = await ApiService.call('clearDashboardCache');
            if (response.success) {
                console.log('âœ… ç·©å­˜å·²æ¸…é™¤');
                await loadDashboard(false);
            } else {
                alert('æ¸…é™¤ç·©å­˜å¤±æ•—: ' + response.error);
                setDashboardLoading(false);
            }
        } catch (error) {
            alert('æ¸…é™¤ç·©å­˜å¤±æ•—: ' + error.message);
            setDashboardLoading(false);
        }
    }

    // ==============================================================================
    // é€šç”¨è¼”åŠ©å‡½æ•¸
    // ==============================================================================
    function setupTabs() {
        const buttons = document.querySelectorAll('.tab-button');
        const panels = document.querySelectorAll('.tab-panel');
        
        buttons.forEach(button => {
            button.addEventListener('click', e => {
                e.preventDefault();
                
                buttons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.add('hidden'));
                
                button.classList.add('active');
                const targetPanel = document.getElementById(button.dataset.tab + 'Panel');
                targetPanel.classList.remove('hidden');
                
                if (button.dataset.tab === 'config') {
                    const configDisplay = document.getElementById('configDisplay');
                    if (configDisplay.innerHTML.includes('loading-spinner-large')) {
                        loadSystemConfig();
                    }
                }
            });
        });
    }
    
    function showError(containerId, message) { 
        document.getElementById(containerId).innerHTML = `<div class="error-message">âŒ ${message}</div>`; 
    }
    
    function getScoreColor(score) { 
        if (score > 0) return '#22c55e'; 
        if (score < 0) return '#ef4444'; 
        return '#6b7280'; 
    }
    
    function getScoreClass(score) { 
        if (score >= 3) return 'score-strong-bullish'; 
        if (score >= 1) return 'score-moderate-bullish'; 
        if (score > -1) return 'score-neutral'; 
        if (score > -3) return 'score-moderate-bearish'; 
        return 'score-strong-bearish'; 
    }
    
    function getNestedValue(obj, path) { 
        return path.split('.').reduce((current, key) => current && current[key], obj); 
    }

    // ==============================================================================
    // ç¨‹å¼å…¥å£ - è‡ªå‹•åˆå§‹åŒ–
    // ==============================================================================
    console.log('D-Regime V2.8 GitHub Pages ç‰ˆæœ¬å·²åŠ è¼‰å®Œæˆ');
    </script>
</body>
</html>
